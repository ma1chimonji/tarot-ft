<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>TAROT CONSOLE v11.0</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
  :root{
    --bg:#0b0f14; --panel:#10151d; --ink:#e6edf3; --muted:#9fb0c3; 
    --accent:#64b5f6; --soft:#151c26; --line:#1f2a38; 
    --ok:#64f6c2; --err:#ff8b8b; --warn:#f6d864; 
    --card-bg: #1c2533; --card-back: #2c3e50;
    
    /* Magic Circle */
    --magic-line: rgba(100, 181, 246, 0.15);
    --magic-glow: rgba(100, 181, 246, 0.05);
    
    /* Defaults */
    --card-w: 120px; --card-h: 200px;
    --font-scale: 1; --sidebar-w: 300px;
  }

  /* --- Mobile Responsive (Drawer UI) --- */
  @media (max-width: 768px) {
    :root { --card-w: 60px; --card-h: 100px; --font-scale: 0.6; --sidebar-w: 0px; }
    
    /* Layout Reset */
    .wrap { display: block !important; position: relative; height: 100vh; }
    
    /* Main fills screen */
    main { 
      width: 100%; height: 100vh; 
      position: absolute; top: 0; left: 0; 
      padding-bottom: 60px; /* Space for FAB */
    }

    /* Aside becomes a Drawer (Bottom Sheet) */
    aside {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      height: 60vh; /* Panel Height */
      border-radius: 20px 20px 0 0;
      border-top: 1px solid var(--accent);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
      transform: translateY(110%); /* Hidden by default */
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 1000;
      padding-bottom: 30px; /* Safe area */
    }
    
    /* Active State for Drawer */
    aside.active { transform: translateY(0); }

    /* Floating Action Button (Menu Trigger) */
    .fab-menu {
      display: flex !important;
    }

    /* Close Button inside Drawer */
    .drawer-close {
      display: block !important;
    }
    
    .log-list { font-size: 10px; }
    .btn { padding: 8px 10px; font-size: 12px; }
  }

  /* --- Base Styles --- */
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,sans-serif; height: 100vh; overflow: hidden;}
  
  /* Header hidden on mobile to save space, visible on PC */
  header{padding:0 18px; height: 50px; border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center; z-index: 20; position: relative; background: var(--bg);}
  @media (max-width: 768px) { header { display: none; } }

  .wrap{display:grid; grid-template-columns: var(--sidebar-w) 1fr; height:calc(100vh - 50px);}
  
  aside{background:var(--panel);border-right:1px solid var(--line);padding:20px;overflow:auto; display:flex; flex-direction:column; gap: 15px; z-index: 20; position: relative;}

  /* Floating Menu Button (Mobile Only) */
  .fab-menu {
    display: none;
    position: fixed; bottom: 20px; right: 20px;
    width: 50px; height: 50px;
    background: var(--accent); color: #000;
    border-radius: 50%;
    align-items: center; justify-content: center;
    box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
    z-index: 500; cursor: pointer;
    font-size: 20px;
  }
  
  /* Drawer Close Bar (Mobile Only) */
  .drawer-close {
    display: none;
    width: 40px; height: 5px; background: var(--line);
    border-radius: 10px; margin: 0 auto 15px;
    cursor: pointer;
  }

  /* Main & Particles */
  main { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background-color: #0b0f14; }
  main::before {
    content: ""; position: absolute; top: 50%; left: 50%;
    width: 150vmax; height: 150vmax; transform: translate(-50%, -50%);
    z-index: 0; opacity: 0.5; pointer-events: none;
    background-image: 
      repeating-conic-gradient(from 0deg at center, transparent 0deg, transparent 4deg, var(--magic-line) 4deg, var(--magic-line) 5deg, transparent 5deg, transparent 10deg),
      radial-gradient(circle at center, transparent 45%, var(--magic-glow) 45%, var(--magic-glow) 50%, transparent 50%),
      radial-gradient(circle at center, var(--magic-glow) 0%, transparent 20%);
    background-position: center; background-repeat: no-repeat;
    animation: spinMagic 120s linear infinite;
  }
  @keyframes spinMagic { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

  #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; pointer-events: none; }

  /* UI Elements */
  .label{font-size:11px;color:var(--muted);margin:0 0 4px; text-transform: uppercase; letter-spacing: 0.5px;}
  .btn{background:var(--soft);color:var(--accent);border:1px solid var(--line);border-radius:4px;padding:12px; cursor:pointer; font-family: monospace; transition: all 0.2s; width: 100%; text-align: center; font-weight:bold;}
  .btn:hover{background:var(--line); color: #fff;}
  .btn-save { color: var(--ok); border-color: var(--line); }
  select { width: 100%; padding: 10px; background: var(--soft); color: var(--ink); border: 1px solid var(--line); border-radius: 4px; font-family: monospace; font-size: 14px;}
  
  .log-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 12px;}
  .log-list li { border-bottom: 1px solid var(--line); padding: 8px 0; color: var(--muted); display: flex; flex-direction: column; gap: 2px;}
  .log-list li .log-header { display: flex; justify-content: space-between; color: var(--ink); }
  .log-list li .log-detail { font-size: 11px; color: var(--muted); padding-left: 8px; border-left: 2px solid var(--accent); }
  .log-list li.rev .log-detail { border-left-color: var(--warn); }

  /* Cards */
  #spread-container { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 10; }
  .card-slot { 
    position: absolute; width: var(--card-w); height: var(--card-h); 
    perspective: 1000px; cursor: pointer; transition: all 0.3s; 
    margin-top: calc(var(--card-h) / -2); margin-left: calc(var(--card-w) / -2);
  }
  .card-slot:hover { transform: scale(1.05) !important; z-index: 100 !important; }
  .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
  .card-slot.flipped .card { transform: rotateY(180deg); }
  .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0; box-sizing: border-box; border: 1px solid var(--line); overflow: hidden;}
  .card-back { background: var(--card-back); background-image: repeating-linear-gradient(45deg, var(--line) 0, var(--line) 1px, transparent 0, transparent 50%); background-size: 10px 10px; color: var(--muted); display:flex; justify-content:center; align-items:center;}
  .card-front { background: var(--card-bg); transform: rotateY(180deg); text-align: center; }

  .pos-badge { width: 100%; background: var(--line); color: var(--ok); font-size: calc(10px * var(--font-scale)); padding: 4px 0; text-align: center; font-weight: bold; border-bottom: 1px solid var(--soft); margin-bottom: 4px; }
  .card-content-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; width: 100%; overflow: hidden; }
  .suit-icon { font-size: calc(24px * var(--font-scale)); margin-bottom: 2px; display: inline-block; }
  .card-name { font-size: calc(11px * var(--font-scale)); font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid var(--accent); padding-bottom: 2px; width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-meaning { font-size: calc(9px * var(--font-scale)); color: var(--muted); line-height: 1.3; overflow-y: auto; text-align: left; width: 95%; }
  .reversed-state .suit-icon { transform: rotate(180deg); }
  .reversed-state .card-name { border-bottom-color: var(--warn); color: var(--warn); }
  .reversed-tag { font-size: calc(8px * var(--font-scale)); color: var(--warn); display: block; font-weight: bold; margin-bottom: 2px;}
  .suit-wands { color: #ff8b8b; } .suit-cups { color: #64b5f6; } .suit-swords { color: #f6d864; } .suit-pentacles { color: #64f6c2; } .suit-major { color: #b07aa1; }
</style>
</head>
<body>

<header>
  <h1>ðŸ”® TAROT CONSOLE</h1>
</header>

<div class="fab-menu" id="menuBtn">â‰¡</div>

<div class="wrap">
  <aside id="drawer">
    <div class="drawer-close" id="closeMenuBtn"></div>

    <div style="flex-shrink: 0; display:flex; flex-direction: column; gap: 15px;">
      <div>
        <div class="label">SPREAD SELECTOR</div>
        <select id="spreadSelect"></select>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="deployBtn" style="flex:2">ðŸ”® DRAW CARDS</button>
        <button class="btn btn-save" id="saveBtn" style="flex:1">ðŸ“¸ PNG</button>
      </div>
    </div>
    
    <div style="flex:1; overflow: auto; border-top:1px solid var(--line); margin-top:10px; padding-top:10px;">
      <div class="label">SESSION LOG</div>
      <ul class="log-list" id="history"></ul>
    </div>
  </aside>

  <main id="capture-area">
    <canvas id="particle-canvas"></canvas>
    <div id="spread-container">
      <div style="color: var(--muted); font-size: 12px; text-align:center; position: relative; z-index: 100; margin-top: 40vh;">
        TAP MENU TO START
      </div>
    </div>
  </main>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  
  // --- Data ---
  const baseDeck = [
    {suit:'major', name:'0. æ„šè€…', icon:'ðŸ¤¡', advice:'å†’é™ºå¿ƒã€è‡ªç”±', advice_rev:'ç„¡è¨ˆç”»ã€è»½çŽ‡'}, {suit:'major', name:'I. é­”è¡“å¸«', icon:'ðŸ§™', advice:'å‰µé€ æ€§ã€æº–å‚™å®Œäº†', advice_rev:'æº–å‚™ä¸è¶³ã€æ‚ªç”¨'}, {suit:'major', name:'II. å¥³æ•™çš‡', icon:'ðŸŒ™', advice:'ç›´æ„Ÿã€é™å¯‚', advice_rev:'ç¥žçµŒè³ªã€æ‰¹åˆ¤'}, {suit:'major', name:'III. å¥³å¸', icon:'ðŸ‘‘', advice:'è±Šã‹ã•ã€æ¯æ€§', advice_rev:'ã‚ãŒã¾ã¾ã€æµªè²»'}, {suit:'major', name:'IV. çš‡å¸', icon:'ðŸ›ï¸', advice:'è²¬ä»»æ„Ÿã€å®‰å®š', advice_rev:'æ¨ªæš´ã€æœªç†Ÿ'}, {suit:'major', name:'V. æ•™çš‡', icon:'ðŸ“œ', advice:'ä¿¡é ¼ã€æ…ˆæ‚²', advice_rev:'ç‹­ã„è¦–é‡Žã€å­¤ç«‹'}, {suit:'major', name:'VI. æ‹äºº', icon:'ðŸ’ž', advice:'åˆæ„ã€èª¿å’Œ', advice_rev:'è¿·ã„ã€èª˜æƒ‘'}, {suit:'major', name:'VII. æˆ¦è»Š', icon:'ðŸš€', advice:'å‹åˆ©ã€å‰é€²', advice_rev:'æš´èµ°ã€åœæ»ž'}, {suit:'major', name:'VIII. åŠ›', icon:'ðŸ¦', advice:'å¿è€ã€å‹‡æ°—', advice_rev:'è‡ªä¿¡éŽå‰°ã€ææ€–'}, {suit:'major', name:'IX. éš è€…', icon:'ðŸ”¦', advice:'å†…çœã€æŽ¢ç©¶', advice_rev:'å­¤ç‹¬ã€åå±ˆ'}, {suit:'major', name:'X. é‹å‘½ã®è¼ª', icon:'ðŸŽ¡', advice:'å¥½è»¢ã€ãƒãƒ£ãƒ³ã‚¹', advice_rev:'æ‚ªåŒ–ã€ä¸é‹'}, {suit:'major', name:'XI. æ­£ç¾©', icon:'âš–ï¸', advice:'å…¬å¹³ã€ãƒãƒ©ãƒ³ã‚¹', advice_rev:'ä¸æ­£ã€åè¦‹'}, {suit:'major', name:'XII. åŠã‚‰ã‚ŒãŸç”·', icon:'ðŸ™ƒ', advice:'è©¦ç·´ã€è¦–ç‚¹ã®å¤‰åŒ–', advice_rev:'å¾’åŠ´ã€ç—©ã›æˆ‘æ…¢'}, {suit:'major', name:'XIII. æ­»ç¥ž', icon:'ðŸ’€', advice:'çµ‚ç„‰ã€åˆ·æ–°', advice_rev:'æœªç·´ã€åœæ»ž'}, {suit:'major', name:'XIV. ç¯€åˆ¶', icon:'ðŸº', advice:'å¾ªç’°ã€èª¿æ•´', advice_rev:'ä¸å‡è¡¡ã€æ¥µç«¯'}, {suit:'major', name:'XV. æ‚ªé­”', icon:'ðŸ˜ˆ', advice:'æ¬²æœ›ã€åŸ·ç€', advice_rev:'æŸç¸›ã‹ã‚‰ã®è§£æ”¾'}, {suit:'major', name:'XVI. å¡”', icon:'âš¡', advice:'å´©å£Šã€å¤‰åŒ–', advice_rev:'ç·Šè¿«ã€èª¤è§£'}, {suit:'major', name:'XVII. æ˜Ÿ', icon:'ðŸŒŸ', advice:'å¸Œæœ›ã€ç†æƒ³', advice_rev:'å¹»æ»…ã€é«˜æœ›ã¿'}, {suit:'major', name:'XVIII. æœˆ', icon:'ðŸ¦ž', advice:'ä¸å®‰ã€æ½œåœ¨æ„è­˜', advice_rev:'ä¸å®‰ã®è§£æ¶ˆ'}, {suit:'major', name:'XIX. å¤ªé™½', icon:'â˜€ï¸', advice:'æˆåŠŸã€ç¥ç¦', advice_rev:'å»¶æœŸã€ä¸­æ­¢'}, {suit:'major', name:'XX. å¯©åˆ¤', icon:'ðŸŽº', advice:'å¾©æ´»ã€è¦šé†’', advice_rev:'æ‚”æ¨ã€è¿·ã„'}, {suit:'major', name:'XXI. ä¸–ç•Œ', icon:'ðŸŒ', advice:'å®Œæˆã€ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰', advice_rev:'æœªå®Œæˆã€ã‚¹ãƒ©ãƒ³ãƒ—'}
  ];
  const suits = [ {id:'wands', icon:'ðŸ”¥', name:'ãƒ¯ãƒ³ãƒ‰', k_up:'æƒ…ç†±', k_rev:'ç©ºå›žã‚Š'}, {id:'cups', icon:'ðŸ·', name:'ã‚«ãƒƒãƒ—', k_up:'æ„Ÿæƒ…', k_rev:'æƒ…ç·’ä¸å®‰å®š'}, {id:'swords', icon:'âš”ï¸', name:'ã‚½ãƒ¼ãƒ‰', k_up:'æ€è€ƒ', k_rev:'æ··ä¹±'}, {id:'pentacles', icon:'ðŸª™', name:'ãƒšãƒ³ã‚¿ã‚¯ãƒ«', k_up:'ç‰©è³ª', k_rev:'æå¤±'} ];
  const numbers = [ {n:'A', up:'å§‹ã¾ã‚Š', rev:'é…ã‚Œ'}, {n:'2', up:'ãƒãƒ©ãƒ³ã‚¹', rev:'ä¸å’Œ'}, {n:'3', up:'ç™ºå±•', rev:'åœæ­¢'}, {n:'4', up:'å®‰å®š', rev:'å›ºåŸ·'}, {n:'5', up:'è‘›è—¤', rev:'æ•—åŒ—'}, {n:'6', up:'å‹åˆ©', rev:'å¾Œé€€'}, {n:'7', up:'å„ªä½', rev:'ä¸åˆ©'}, {n:'8', up:'æ€¥å±•é–‹', rev:'åœæ»ž'}, {n:'9', up:'å‚™ãˆ', rev:'æ¶ˆè€—'}, {n:'10', up:'å®Œäº†', rev:'å´©å£Š'}, {n:'P', up:'å­¦ç¿’', rev:'æœªç†Ÿ'}, {n:'Kn', up:'è¡Œå‹•', rev:'æš´èµ°'}, {n:'Q', up:'å—å®¹', rev:'å«‰å¦¬'}, {n:'K', up:'çµ±çŽ‡', rev:'ç‹¬è£'} ];
  suits.forEach(s => { numbers.forEach(num => { baseDeck.push({suit:s.id, name:`${s.name} ${num.n}`, icon:s.icon, advice:`${s.k_up}ã®${num.up}`, advice_rev:`${s.k_rev}ã¾ãŸã¯${num.rev}`}); }); });

  const spreads = {
    oneCard: { name: "1æžšå¼•ã", positions: [ {id:1, mean:"Focus", pos:[50,50]} ] },
    letGoGrow: { name: "æ‰‹æ”¾ã™/è‚²ã¦ã‚‹", positions: [ {id:1, mean:"æ‰‹æ”¾ã™ã¹ãã‚‚ã®", pos:[50, 30]}, {id:2, mean:"è‚²ã¦ã‚‹ã¹ãæœ¬è³ª", pos:[50, 70]} ]},
    pastPresentFuture: { name: "éŽåŽ»/ç¾åœ¨/æœªæ¥", positions: [ {id:1, mean:"éŽåŽ»ã®çŠ¶æ³", pos:[50, 20]}, {id:2, mean:"ç¾åœ¨ã®çŠ¶æ³", pos:[50, 50]}, {id:3, mean:"æœªæ¥ã®çŠ¶æ³", pos:[50, 80]} ]},
    essentialKey: { name: "ä¸å¯æ¬ ãªéµ", positions: [ {id:1, mean:"ç¾åœ¨ã®çŠ¶æ³", pos:[45, 40]}, {id:2, mean:"éŽåŽ»ã®å‡ºæ¥äº‹", pos:[55, 20]}, {id:3, mean:"è‡ªåˆ†ã®èƒ½åŠ›", pos:[30, 60]}, {id:4, mean:"æƒ…ç†±ãƒ»èˆˆå‘³", pos:[35, 80], rotate: 20}, {id:5, mean:"èµ·ã“ã‚Šã†ã‚‹çµæžœ", pos:[65, 60]} ]},
    triquetra: { name: "ãƒˆãƒªã‚±ãƒˆãƒ©", positions: [ {id:1, mean:"è‡ªå·±", pos:[35, 50]}, {id:2, mean:"ç¤¾ä¼š", pos:[65, 30]}, {id:3, mean:"ç›´æ„Ÿ", pos:[65, 70]} ]},
    hexagram: { name: "ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ ", positions: [ {id:1, mean:"éŽåŽ»", pos:[20, 50]}, {id:2, mean:"ç¾åœ¨", pos:[80, 50]}, {id:3, mean:"æœªæ¥", pos:[50, 20]}, {id:4, mean:"å¯¾ç­–", pos:[80, 80]}, {id:5, mean:"ç›¸æ‰‹", pos:[80, 20]}, {id:6, mean:"è‡ªåˆ†", pos:[20, 80]}, {id:7, mean:"çµè«–", pos:[50, 50], z:2} ]},
    celticCross: { name: "ã‚±ãƒ«ãƒˆåå­—", positions: [ {id:1, mean:"ç¾çŠ¶", pos:[50, 35]}, {id:2, mean:"éšœå®³", pos:[50, 35], rotate: 90, z:1}, {id:3, mean:"é¡•åœ¨", pos:[20, 35]}, {id:4, mean:"æ½œåœ¨", pos:[80, 35]}, {id:5, mean:"éŽåŽ»", pos:[50, 10]}, {id:6, mean:"æœªæ¥", pos:[50, 60]}, {id:7, mean:"è‡ªèº«", pos:[85, 85]}, {id:8, mean:"å‘¨å›²", pos:[65, 85]}, {id:9, mean:"é¡˜æœ›", pos:[45, 85]}, {id:10, mean:"çµæžœ", pos:[25, 85]} ]},
    findingLove: { name: "æ–°ã—ã„æ‹", positions: [ {id:1, mean:"ç¾çŠ¶", pos:[50, 50]}, {id:2, mean:"ç›¸æ‰‹ã®ç‰¹å¾´", pos:[25, 20]}, {id:3, mean:"å‡ºä¼šã†å ´æ‰€", pos:[25, 80]}, {id:4, mean:"èª²é¡Œ", pos:[75, 20]}, {id:5, mean:"çµæžœ", pos:[75, 80]} ]},
    diamondCross: { name: "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰", positions: [ {id:1, mean:"è‡ªåˆ†", pos:[50, 20]}, {id:2, mean:"ç›¸æ‰‹", pos:[50, 80]}, {id:3, mean:"äºŒäººã®ç¾çŠ¶", pos:[20, 50]}, {id:4, mean:"æœªæ¥", pos:[80, 50]} ]},
    twoPaths: { name: "âš–ï¸ äºŒè€…æŠžä¸€", positions: [ {id:1, mean:"å²è·¯", pos:[80, 50]}, {id:2, mean:"Aã®æœªæ¥", pos:[30, 25]}, {id:3, mean:"Bã®æœªæ¥", pos:[30, 75]}, {id:4, mean:"AåŠ©è¨€", pos:[55, 25]}, {id:5, mean:"BåŠ©è¨€", pos:[55, 75]} ]},
    interview: { name: "ðŸŽ¯ é¢æŽ¥æ”»ç•¥", positions: [ {id:1, mean:"å¼·ã¿", pos:[50, 20]}, {id:2, mean:"ç›¸æ‰‹ã®è¦æœ›", pos:[50, 80]}, {id:3, mean:"æ”»ç•¥ã®éµ", pos:[20, 50]}, {id:4, mean:"çµæžœ", pos:[80, 50]} ]},
    careerPath: { name: "ðŸš€ ã‚­ãƒ£ãƒªã‚¢", positions: [ {id:1, mean:"å®ŸåŠ›", pos:[50, 15]}, {id:2, mean:"ç›®æ¨™", pos:[30, 25]}, {id:3, mean:"æ‰èƒ½", pos:[20, 50]}, {id:4, mean:"èª²é¡Œ", pos:[30, 75]}, {id:5, mean:"ç’°å¢ƒ", pos:[50, 85]}, {id:6, mean:"è¡Œå‹•", pos:[70, 50]}, {id:7, mean:"æˆæžœ", pos:[50, 50], z:2} ]}
  };

  /* --- Particles --- */
  class ParticleSystem {
    constructor(canvasId) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext('2d');
      this.particles = [];
      this.ambientParticles = [];
      this.resize();
      window.addEventListener('resize', () => this.resize());
      for(let i=0; i<30; i++) this.ambientParticles.push(this.createAmbient());
      this.animate();
    }
    resize() {
      this.canvas.width = this.canvas.parentElement.offsetWidth;
      this.canvas.height = this.canvas.parentElement.offsetHeight;
    }
    createAmbient() {
      return { x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5, size: Math.random()*2+0.5, alpha: Math.random()*0.5+0.1 };
    }
    createExplosion(x, y) {
      for (let i=0; i<40; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 5 + 2;
        this.particles.push({ x, y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, size: Math.random()*3+1, alpha: 1, decay: Math.random()*0.02+0.01, color: Math.random()>0.5?'#64b5f6':'#64f6c2' });
      }
    }
    animate() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.ambientParticles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if(p.x<0) p.x=this.canvas.width; if(p.x>this.canvas.width) p.x=0;
        if(p.y<0) p.y=this.canvas.height; if(p.y>this.canvas.height) p.y=0;
        this.ctx.fillStyle = `rgba(160, 200, 255, ${p.alpha})`;
        this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
      });
      for (let i = this.particles.length-1; i>=0; i--) {
        const p = this.particles[i];
        p.x += p.vx; p.y += p.vy; p.alpha -= p.decay; p.size *= 0.96;
        if (p.alpha <= 0) this.particles.splice(i, 1);
        else { this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.alpha; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha = 1.0; }
      }
      requestAnimationFrame(() => this.animate());
    }
  }

  /* --- Logic --- */
  const el = { select: $('#spreadSelect'), btn: $('#deployBtn'), saveBtn: $('#saveBtn'), container: $('#spread-container'), list: $('#history'), main: $('main'), menuBtn: $('#menuBtn'), drawer: $('#drawer'), closeMenuBtn: $('#closeMenuBtn') };
  let currentDeck = [];
  const particles = new ParticleSystem('particle-canvas');

  // Drawer Toggle
  function toggleDrawer() { el.drawer.classList.toggle('active'); }
  el.menuBtn.onclick = toggleDrawer;
  el.closeMenuBtn.onclick = toggleDrawer;

  function init(){
    for(const key in spreads){
      const opt = document.createElement('option');
      opt.value = key; opt.textContent = spreads[key].name;
      el.select.appendChild(opt);
    }
    el.select.value = 'oneCard';
    deploySpread();
  }

  function prepareDeck(){
    currentDeck = [...baseDeck];
    for (let i=currentDeck.length-1; i>0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
    }
  }

  function drawCard(){
    if(currentDeck.length===0) prepareDeck();
    const card = currentDeck.pop();
    const isRev = Math.random() < 0.5;
    return { ...card, isReversed: isRev };
  }

  function deploySpread(){
    const spreadKey = el.select.value;
    const spreadData = spreads[spreadKey];
    prepareDeck();
    el.container.innerHTML = '';
    
    // Auto close drawer on mobile when deploying
    if(window.innerWidth <= 768) el.drawer.classList.remove('active');

    addLog('System', `Spread: ${spreadData.name}`);
    spreadData.positions.forEach(pos => createCardSlot(pos));
  }

  function createCardSlot(posInfo){
    const slot = document.createElement('div');
    slot.className = 'card-slot';
    slot.style.top = `${posInfo.pos[0]}%`;
    slot.style.left = `${posInfo.pos[1]}%`;
    if(posInfo.rotate) slot.style.transform = `rotate(${posInfo.rotate}deg)`;
    if(posInfo.z) slot.style.zIndex = posInfo.z;

    slot.innerHTML = `
      <div class="card">
        <div class="card-face card-back"><span>${posInfo.id}</span><span style="font-size:10px;margin-top:4px;">${posInfo.mean.substring(0,4)}</span></div>
        <div class="card-face card-front"></div>
      </div>
    `;

    slot.onclick = function(e){
      if(this.classList.contains('flipped')) return;
      const rect = el.main.getBoundingClientRect();
      particles.createExplosion(e.clientX - rect.left, e.clientY - rect.top);
      
      const c = drawCard();
      const front = this.querySelector('.card-front');
      const mean = c.isReversed ? c.advice_rev : c.advice;
      const revTag = c.isReversed ? '<span class="reversed-tag">â–¼REVERSED</span>' : '';
      if(c.isReversed) front.classList.add('reversed-state');

      front.innerHTML = `
        <div class="pos-badge">${posInfo.id}. ${posInfo.mean}</div>
        <div class="card-content-wrap">
          ${revTag}
          <span class="suit-icon suit-${c.suit}">${c.icon}</span>
          <span class="card-name">${c.name}</span>
          <div class="card-meaning">${mean}</div>
        </div>
      `;
      this.classList.add('flipped');
      addLog('Reveal', `${posInfo.mean}: ${c.name}`, c.isReversed);
    };
    el.container.appendChild(slot);
  }

  function addLog(header, detail, isRev=false){
    const li = document.createElement('li');
    if(isRev) li.className = 'rev';
    li.innerHTML = `<span class="log-header">${header}</span><span class="log-detail">${detail}</span>`;
    el.list.prepend(li);
  }

  el.saveBtn.onclick = function(){
    const t = el.main;
    const txt = el.saveBtn.textContent;
    el.saveBtn.textContent = "...";
    html2canvas(t, { backgroundColor: '#0b0f14', scale: 2, useCORS: true, logging: false }).then(canvas => {
      const link = document.createElement('a');
      link.download = `tarot_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL();
      link.click();
      el.saveBtn.textContent = txt;
    });
  };

  el.btn.onclick = deploySpread;
  init();
})();
</script>
</body>
</html>
