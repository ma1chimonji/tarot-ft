<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>TAROT CONSOLE v9.0</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
  :root{
    --bg:#0b0f14; --panel:#10151d; --ink:#e6edf3; --muted:#9fb0c3; 
    --accent:#64b5f6; --soft:#151c26; --line:#1f2a38; 
    --ok:#64f6c2; --err:#ff8b8b; --warn:#f6d864; 
    --card-bg: #1c2533; --card-back: #2c3e50;
    
    /* Magic Circle Colors */
    --magic-line: rgba(100, 181, 246, 0.15);
    --magic-glow: rgba(100, 181, 246, 0.05);
    
    /* PC Defaults */
    --card-w: 120px; --card-h: 200px;
    --font-scale: 1; --sidebar-w: 300px;
  }

  @media (max-width: 768px) {
    :root { --card-w: 65px; --card-h: 110px; --font-scale: 0.6; --sidebar-w: 0px; }
    header h1 { font-size: 14px; }
    .wrap { display: flex !important; flex-direction: column; }
    aside { order: 2; height: 30vh; border-right: none; border-top: 1px solid var(--line); padding: 10px; }
    main { order: 1; height: 70vh; }
    .log-list { font-size: 10px; }
    .btn { padding: 8px 10px; font-size: 12px; }
  }

  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,sans-serif; height: 100vh; overflow: hidden;}
  
  header{padding:0 18px; height: 50px; border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center; z-index: 20; position: relative; background: var(--bg);}
  header h1{font-size:16px;margin:0; font-family: monospace; letter-spacing: 1px;}

  .wrap{display:grid; grid-template-columns: var(--sidebar-w) 1fr; height:calc(100vh - 50px);}
  
  aside{background:var(--panel);border-right:1px solid var(--line);padding:14px;overflow:auto; display:flex; flex-direction:column; gap: 15px; z-index: 20; position: relative;}

  /* Main Area & Background */
  main {
    position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 0; overflow: hidden; background-color: #0b0f14;
  }

  /* CSS Magic Circle (Background Layer) */
  main::before {
    content: ""; position: absolute; top: 50%; left: 50%;
    width: 150vmax; height: 150vmax; transform: translate(-50%, -50%);
    z-index: 0; opacity: 0.5; pointer-events: none;
    background-image: 
      repeating-conic-gradient(from 0deg at center, transparent 0deg, transparent 4deg, var(--magic-line) 4deg, var(--magic-line) 5deg, transparent 5deg, transparent 10deg),
      conic-gradient(from 30deg at center, var(--magic-line) 0deg, transparent 2deg, transparent 58deg, var(--magic-line) 60deg, transparent 62deg, transparent 118deg, var(--magic-line) 120deg, transparent 122deg, transparent 178deg, var(--magic-line) 180deg, transparent 182deg, transparent 238deg, var(--magic-line) 240deg, transparent 242deg, transparent 298deg, var(--magic-line) 300deg, transparent 302deg),
      radial-gradient(circle at center, transparent 65%, var(--magic-line) 65%, var(--magic-line) 66%, transparent 66%, transparent 68%, var(--magic-line) 68%, var(--magic-line) 69%, transparent 69%),
      radial-gradient(circle at center, transparent 45%, var(--magic-glow) 45%, var(--magic-glow) 50%, transparent 50%),
      radial-gradient(circle at center, var(--magic-glow) 0%, transparent 20%);
    background-position: center; background-repeat: no-repeat;
    animation: spinMagic 120s linear infinite;
  }
  @keyframes spinMagic { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

  /* Particle Canvas (Interaction Layer) */
  #particle-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 15; /* Cards are z-index 10-100, but we want particles above background but clickable through? No, creating distinct layer */
    pointer-events: none; /* Allows clicking through the canvas to the cards */
  }

  /* UI Components */
  .label{font-size:11px;color:var(--muted);margin:0 0 4px; text-transform: uppercase; letter-spacing: 0.5px;}
  .btn{background:var(--soft);color:var(--accent);border:1px solid var(--line);border-radius:4px;padding:10px 20px;cursor:pointer; font-family: monospace; transition: all 0.2s; width: 100%; text-align: center;}
  .btn:hover{background:var(--line); color: #fff; box-shadow: 0 0 10px rgba(100, 181, 246, 0.2);}
  .btn-save { color: var(--ok); border-color: var(--line); }
  .btn-save:hover { background: var(--line); box-shadow: 0 0 10px rgba(100, 246, 194, 0.2); }
  select { width: 100%; padding: 8px; background: var(--soft); color: var(--ink); border: 1px solid var(--line); border-radius: 4px; font-family: monospace; }
  
  .log-list { list-style: none; padding: 0; margin: 0; font-family: monospace; font-size: 12px;}
  .log-list li { border-bottom: 1px solid var(--line); padding: 6px 0; color: var(--muted); display: flex; flex-direction: column; gap: 2px;}
  .log-list li .log-header { display: flex; justify-content: space-between; color: var(--ink); }
  .log-list li .log-detail { font-size: 10px; color: var(--muted); padding-left: 8px; border-left: 2px solid var(--accent); }
  .log-list li.rev .log-detail { border-left-color: var(--warn); }

  #spread-container { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 10; }

  .card-slot { 
    position: absolute; width: var(--card-w); height: var(--card-h); 
    perspective: 1000px; cursor: pointer; transition: all 0.3s; 
    margin-top: calc(var(--card-h) / -2); margin-left: calc(var(--card-w) / -2);
  }
  .card-slot:hover { transform: scale(1.05) !important; z-index: 100 !important; }

  .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
  .card-slot.flipped .card { transform: rotateY(180deg); }

  .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0; box-sizing: border-box; border: 1px solid var(--line); overflow: hidden;}
  .card-back { background: var(--card-back); background-image: repeating-linear-gradient(45deg, var(--line) 0, var(--line) 1px, transparent 0, transparent 50%); background-size: 10px 10px; color: var(--muted); font-family: monospace; font-size: 12px; justify-content: center;}
  .card-front { background: var(--card-bg); transform: rotateY(180deg); text-align: center; }

  .pos-badge { width: 100%; background: var(--line); color: var(--ok); font-size: calc(10px * var(--font-scale)); padding: 4px 0; text-align: center; font-weight: bold; border-bottom: 1px solid var(--soft); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-content-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; width: 100%; overflow: hidden; }
  .suit-icon { font-size: calc(24px * var(--font-scale)); margin-bottom: 2px; display: inline-block; transition: transform 0.3s; }
  .card-name { font-size: calc(11px * var(--font-scale)); font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid var(--accent); padding-bottom: 2px; width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-meaning { font-size: calc(9px * var(--font-scale)); color: var(--muted); line-height: 1.3; overflow-y: auto; text-align: left; width: 95%; word-break: break-all;}
  .reversed-state .suit-icon { transform: rotate(180deg); }
  .reversed-state .card-name { border-bottom-color: var(--warn); color: var(--warn); }
  .reversed-tag { font-size: calc(8px * var(--font-scale)); color: var(--warn); display: block; font-weight: bold; margin-bottom: 2px;}
  .suit-wands { color: #ff8b8b; } .suit-cups { color: #64b5f6; } .suit-swords { color: #f6d864; } .suit-pentacles { color: #64f6c2; } .suit-major { color: #b07aa1; }
</style>
</head>
<body>

<header>
  <h1>Âç†„ÅÑ„ÉéÈ§®</h1>
</header>

<div class="wrap">
  <aside>
    <div style="display:flex; flex-direction: column; gap: 10px;">
      <div>
        <div class="label">Spread</div>
        <select id="spreadSelect"></select>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="deployBtn" style="flex:2">DRAW</button>
        <button class="btn btn-save" id="saveBtn" style="flex:1">üì∏ PNG</button>
      </div>
    </div>
    <div style="flex:1; overflow: auto; border-top:1px solid var(--line); margin-top:10px; padding-top:10px;">
      <div class="label">CARD LOG</div>
      <ul class="log-list" id="history"></ul>
    </div>
  </aside>

  <main id="capture-area">
    <canvas id="particle-canvas"></canvas>
    
    <div id="spread-container">
      <div style="color: var(--muted); font-size: 12px; text-align:center; position: relative; z-index: 100;">Select Spread & Deploy</div>
    </div>
  </main>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  
  /* --- 1. Data Definitions --- */
  const baseDeck = [
    {suit:'major', name:'0. ÊÑöËÄÖ', icon:'ü§°', advice:'ÂÜíÈô∫ÂøÉ„ÄÅËá™Áî±', advice_rev:'ÁÑ°Ë®àÁîª„ÄÅËªΩÁéá'},
    {suit:'major', name:'I. È≠îË°ìÂ∏´', icon:'üßô', advice:'ÂâµÈÄ†ÊÄß„ÄÅÊ∫ñÂÇôÂÆå‰∫Ü', advice_rev:'Ê∫ñÂÇô‰∏çË∂≥„ÄÅÊÇ™Áî®'},
    {suit:'major', name:'II. Â•≥ÊïôÁöá', icon:'üåô', advice:'Áõ¥ÊÑü„ÄÅÈùôÂØÇ', advice_rev:'Á•ûÁµåË≥™„ÄÅÊâπÂà§'},
    {suit:'major', name:'III. Â•≥Â∏ù', icon:'üëë', advice:'Ë±ä„Åã„Åï„ÄÅÊØçÊÄß', advice_rev:'„Çè„Åå„Åæ„Åæ„ÄÅÊµ™Ë≤ª'},
    {suit:'major', name:'IV. ÁöáÂ∏ù', icon:'üèõÔ∏è', advice:'Ë≤¨‰ªªÊÑü„ÄÅÂÆâÂÆö', advice_rev:'Ê®™Êö¥„ÄÅÊú™ÁÜü'},
    {suit:'major', name:'V. ÊïôÁöá', icon:'üìú', advice:'‰ø°È†º„ÄÅÊÖàÊÇ≤', advice_rev:'Áã≠„ÅÑË¶ñÈáé„ÄÅÂ≠§Á´ã'},
    {suit:'major', name:'VI. ÊÅã‰∫∫', icon:'üíû', advice:'ÂêàÊÑè„ÄÅË™øÂíå', advice_rev:'Ëø∑„ÅÑ„ÄÅË™òÊÉë'},
    {suit:'major', name:'VII. Êà¶Ëªä', icon:'üöÄ', advice:'ÂãùÂà©„ÄÅÂâçÈÄ≤', advice_rev:'Êö¥Ëµ∞„ÄÅÂÅúÊªû'},
    {suit:'major', name:'VIII. Âäõ', icon:'ü¶Å', advice:'ÂøçËÄê„ÄÅÂãáÊ∞ó', advice_rev:'Ëá™‰ø°ÈÅéÂâ∞„ÄÅÊÅêÊÄñ'},
    {suit:'major', name:'IX. Èö†ËÄÖ', icon:'üî¶', advice:'ÂÜÖÁúÅ„ÄÅÊé¢Á©∂', advice_rev:'Â≠§Áã¨„ÄÅÂÅèÂ±à'},
    {suit:'major', name:'X. ÈÅãÂëΩ„ÅÆËº™', icon:'üé°', advice:'Â•ΩËª¢„ÄÅ„ÉÅ„É£„É≥„Çπ', advice_rev:'ÊÇ™Âåñ„ÄÅ‰∏çÈÅã'},
    {suit:'major', name:'XI. Ê≠£Áæ©', icon:'‚öñÔ∏è', advice:'ÂÖ¨Âπ≥„ÄÅ„Éê„É©„É≥„Çπ', advice_rev:'‰∏çÊ≠£„ÄÅÂÅèË¶ã'},
    {suit:'major', name:'XII. Âêä„Çâ„Çå„ÅüÁî∑', icon:'üôÉ', advice:'Ë©¶Á∑¥„ÄÅË¶ñÁÇπ„ÅÆÂ§âÂåñ', advice_rev:'ÂæíÂä¥„ÄÅÁó©„ÅõÊàëÊÖ¢'},
    {suit:'major', name:'XIII. Ê≠ªÁ•û', icon:'üíÄ', advice:'ÁµÇÁÑâ„ÄÅÂà∑Êñ∞', advice_rev:'Êú™Á∑¥„ÄÅÂÅúÊªû'},
    {suit:'major', name:'XIV. ÁØÄÂà∂', icon:'üè∫', advice:'Âæ™Áí∞„ÄÅË™øÊï¥', advice_rev:'‰∏çÂùáË°°„ÄÅÊ•µÁ´Ø'},
    {suit:'major', name:'XV. ÊÇ™È≠î', icon:'üòà', advice:'Ê¨≤Êúõ„ÄÅÂü∑ÁùÄ', advice_rev:'ÊùüÁ∏õ„Åã„Çâ„ÅÆËß£Êîæ'},
    {suit:'major', name:'XVI. Â°î', icon:'‚ö°', advice:'Â¥©Â£ä„ÄÅÂ§âÂåñ', advice_rev:'Á∑äËø´„ÄÅË™§Ëß£'},
    {suit:'major', name:'XVII. Êòü', icon:'üåü', advice:'Â∏åÊúõ„ÄÅÁêÜÊÉ≥', advice_rev:'ÂπªÊªÖ„ÄÅÈ´òÊúõ„Åø'},
    {suit:'major', name:'XVIII. Êúà', icon:'ü¶û', advice:'‰∏çÂÆâ„ÄÅÊΩúÂú®ÊÑèË≠ò', advice_rev:'‰∏çÂÆâ„ÅÆËß£Ê∂à'},
    {suit:'major', name:'XIX. Â§™ÈôΩ', icon:'‚òÄÔ∏è', advice:'ÊàêÂäü„ÄÅÁ•ùÁ¶è', advice_rev:'Âª∂Êúü„ÄÅ‰∏≠Ê≠¢'},
    {suit:'major', name:'XX. ÂØ©Âà§', icon:'üé∫', advice:'Âæ©Ê¥ª„ÄÅË¶öÈÜí', advice_rev:'ÊÇîÊÅ®„ÄÅËø∑„ÅÑ'},
    {suit:'major', name:'XXI. ‰∏ñÁïå', icon:'üåç', advice:'ÂÆåÊàê„ÄÅ„Éè„ÉÉ„Éî„Éº„Ç®„É≥„Éâ', advice_rev:'Êú™ÂÆåÊàê„ÄÅ„Çπ„É©„É≥„Éó'},
  ];
  const suits = [
    {id:'wands', icon:'üî•', name:'„ÉØ„É≥„Éâ', k_up:'ÊÉÖÁÜ±', k_rev:'Á©∫Âõû„Çä'},
    {id:'cups', icon:'üç∑', name:'„Ç´„ÉÉ„Éó', k_up:'ÊÑüÊÉÖ', k_rev:'ÊÉÖÁ∑í‰∏çÂÆâÂÆö'},
    {id:'swords', icon:'‚öîÔ∏è', name:'„ÇΩ„Éº„Éâ', k_up:'ÊÄùËÄÉ', k_rev:'Ê∑∑‰π±'},
    {id:'pentacles', icon:'ü™ô', name:'„Éö„É≥„Çø„ÇØ„É´', k_up:'Áâ©Ë≥™', k_rev:'ÊêçÂ§±'}
  ];
  const numbers = [
    {n:'A', up:'Âßã„Åæ„Çä', rev:'ÈÅÖ„Çå'}, {n:'2', up:'„Éê„É©„É≥„Çπ', rev:'‰∏çÂíå'},
    {n:'3', up:'Áô∫Â±ï', rev:'ÂÅúÊ≠¢'}, {n:'4', up:'ÂÆâÂÆö', rev:'Âõ∫Âü∑'},
    {n:'5', up:'ËëõËó§', rev:'ÊïóÂåó'}, {n:'6', up:'ÂãùÂà©', rev:'ÂæåÈÄÄ'},
    {n:'7', up:'ÂÑ™‰Ωç', rev:'‰∏çÂà©'}, {n:'8', up:'ÊÄ•Â±ïÈñã', rev:'ÂÅúÊªû'},
    {n:'9', up:'ÂÇô„Åà', rev:'Ê∂àËÄó'}, {n:'10', up:'ÂÆå‰∫Ü', rev:'Â¥©Â£ä'},
    {n:'Page', up:'Â≠¶Áøí', rev:'Êú™ÁÜü'}, {n:'Knight', up:'Ë°åÂãï', rev:'Êö¥Ëµ∞'},
    {n:'Queen', up:'ÂèóÂÆπ', rev:'Â´âÂ¶¨'}, {n:'King', up:'Áµ±Áéá', rev:'Áã¨Ë£Å'}
  ];
  suits.forEach(s => { numbers.forEach(num => { baseDeck.push({suit:s.id, name:`${s.name} ${num.n}`, icon:s.icon, advice:`${s.k_up}„ÅÆ${num.up}`, advice_rev:`${s.k_rev}„Åæ„Åü„ÅØ${num.rev}`}); }); });

  const spreads = {
    oneCard: { name: "1ÊûöÂºï„Åç", positions: [ {id:1, mean:"‰ªäÊó•„ÅÆFocus", pos:[50,50]} ] },
    letGoGrow: { name: "ÊâãÊîæ„Åô/ËÇ≤„Å¶„Çã", positions: [ {id:1, mean:"ÊâãÊîæ„Åô„Åπ„Åç„ÇÇ„ÅÆ", pos:[50, 30]}, {id:2, mean:"ËÇ≤„Å¶„Çã„Åπ„ÅçÊú¨Ë≥™", pos:[50, 70]} ]},
    pastPresentFuture: { name: "ÈÅéÂéª/ÁèæÂú®/Êú™Êù•", positions: [ {id:1, mean:"ÈÅéÂéª„ÅÆÁä∂Ê≥Å", pos:[50, 20]}, {id:2, mean:"ÁèæÂú®„ÅÆÁä∂Ê≥Å", pos:[50, 50]}, {id:3, mean:"Êú™Êù•„ÅÆÁä∂Ê≥Å", pos:[50, 80]} ]},
    essentialKey: { name: "‰∏çÂèØÊ¨†„Å™Èçµ", positions: [ {id:1, mean:"ÁèæÂú®„ÅÆÁä∂Ê≥Å", pos:[45, 40]}, {id:2, mean:"ÈÅéÂéª„ÅÆÂá∫Êù•‰∫ã", pos:[55, 20]}, {id:3, mean:"Ëá™ÂàÜ„ÅÆËÉΩÂäõ", pos:[30, 60]}, {id:4, mean:"ÊÉÖÁÜ±„ÉªËààÂë≥", pos:[35, 80], rotate: 20}, {id:5, mean:"Ëµ∑„Åì„Çä„ÅÜ„ÇãÁµêÊûú", pos:[65, 60]} ]},
    triquetra: { name: "„Éà„É™„Ç±„Éà„É©", positions: [ {id:1, mean:"Ëá™Â∑±„ÉªÁÑ°ÊÑèË≠ò", pos:[35, 50]}, {id:2, mean:"ÈõÜÂêà‰Ωì„ÉªÁ§æ‰ºö", pos:[65, 30]}, {id:3, mean:"Áõ¥ÊÑü„Éª‰øùË≠∑", pos:[65, 70]} ]},
    hexagram: { name: "„Éò„Ç≠„Çµ„Ç∞„É©„É†(ÊÅã)", positions: [ {id:1, mean:"ÈÅéÂéª", pos:[20, 50]}, {id:2, mean:"ÁèæÂú®", pos:[80, 50]}, {id:3, mean:"Êú™Êù•", pos:[50, 20]}, {id:4, mean:"ÂØæÁ≠ñ„ÉªÁí∞Â¢É", pos:[80, 80]}, {id:5, mean:"Áõ∏Êâã„ÅÆÁä∂Ê≥Å", pos:[80, 20]}, {id:6, mean:"Ëá™ÂàÜ„ÅÆÁä∂Ê≥Å", pos:[20, 80]}, {id:7, mean:"ÊúÄÁµÇÁµêÊûú", pos:[50, 50], z:2} ]},
    celticCross: { name: "„Ç±„É´„ÉàÂçÅÂ≠ó", positions: [ {id:1, mean:"ÁèæÁä∂", pos:[50, 35]}, {id:2, mean:"ÈöúÂÆ≥/ÊîØÊè¥", pos:[50, 35], rotate: 90, z:1}, {id:3, mean:"È°ïÂú®ÊÑèË≠ò", pos:[20, 35]}, {id:4, mean:"ÊΩúÂú®ÊÑèË≠ò", pos:[80, 35]}, {id:5, mean:"ÈÅéÂéª„ÅÆÂéüÂõ†", pos:[50, 10]}, {id:6, mean:"Ëøë„ÅÑÊú™Êù•", pos:[50, 60]}, {id:7, mean:"Êú¨‰∫∫„ÅÆÂßøÂã¢", pos:[85, 85]}, {id:8, mean:"Âë®Âõ≤„ÅÆÁí∞Â¢É", pos:[65, 85]}, {id:9, mean:"Â∏åÊúõ/‰∏çÂÆâ", pos:[45, 85]}, {id:10, mean:"ÊúÄÁµÇÁµêÊûú", pos:[25, 85]} ]},
    findingLove: { name: "Êñ∞„Åó„ÅÑÊÅã", positions: [ {id:1, mean:"ÁèæÁä∂", pos:[50, 50]}, {id:2, mean:"Áõ∏Êâã„ÅÆÁâπÂæ¥", pos:[25, 20]}, {id:3, mean:"Âá∫‰ºö„ÅÜÂ†¥ÊâÄ", pos:[25, 80]}, {id:4, mean:"Ë™≤È°å„ÉªÈöúÂÆ≥", pos:[75, 20]}, {id:5, mean:"ÁµêÊûú", pos:[75, 80]} ]},
    diamondCross: { name: "„ÉÄ„Ç§„É§„É¢„É≥„Éâ", positions: [ {id:1, mean:"Ëá™ÂàÜ", pos:[50, 20]}, {id:2, mean:"Áõ∏Êâã", pos:[50, 80]}, {id:3, mean:"‰∫å‰∫∫„ÅÆÁèæÁä∂", pos:[20, 50]}, {id:4, mean:"Êú™Êù•", pos:[80, 50]} ]}
  };

  /* --- 2. Particle System --- */
  class ParticleSystem {
    constructor(canvasId) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext('2d');
      this.particles = [];
      this.resize();
      
      window.addEventListener('resize', () => this.resize());
      
      // „Ç¢„É≥„Éì„Ç®„É≥„ÉàÁ≤íÂ≠êÔºàËÉåÊôØ„ÅßÊºÇ„ÅÜÁî®Ôºâ
      this.ambientParticles = [];
      for(let i=0; i<30; i++) {
        this.ambientParticles.push(this.createAmbient());
      }

      this.animate();
    }

    resize() {
      this.canvas.width = this.canvas.parentElement.offsetWidth;
      this.canvas.height = this.canvas.parentElement.offsetHeight;
    }

    createAmbient() {
      return {
        x: Math.random() * this.canvas.width,
        y: Math.random() * this.canvas.height,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        size: Math.random() * 2 + 0.5,
        alpha: Math.random() * 0.5 + 0.1,
        life: Infinity
      };
    }

    createExplosion(x, y) {
      const count = 40; // Á≤íÂ≠ê„ÅÆÊï∞
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 5 + 2;
        this.particles.push({
          x: x,
          y: y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          size: Math.random() * 3 + 1,
          alpha: 1,
          decay: Math.random() * 0.02 + 0.01,
          color: Math.random() > 0.5 ? '#64b5f6' : '#64f6c2' // Èùí„Å®Á∑ë„ÅÆÈ≠îÊ≥ïËâ≤
        });
      }
    }

    animate() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

      // Ambient Update
      this.ambientParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        if(p.x < 0) p.x = this.canvas.width;
        if(p.x > this.canvas.width) p.x = 0;
        if(p.y < 0) p.y = this.canvas.height;
        if(p.y > this.canvas.height) p.y = 0;
        
        this.ctx.fillStyle = `rgba(160, 200, 255, ${p.alpha})`;
        this.ctx.beginPath();
        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        this.ctx.fill();
      });

      // Explosion Update
      for (let i = this.particles.length - 1; i >= 0; i--) {
        const p = this.particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.alpha -= p.decay;
        p.size *= 0.96; // Shrink

        if (p.alpha <= 0) {
          this.particles.splice(i, 1);
        } else {
          this.ctx.fillStyle = p.color;
          this.ctx.globalAlpha = p.alpha;
          this.ctx.beginPath();
          this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          this.ctx.fill();
          this.ctx.globalAlpha = 1.0;
        }
      }

      requestAnimationFrame(() => this.animate());
    }
  }

  /* --- 3. App Logic --- */
  const el = { select: $('#spreadSelect'), btn: $('#deployBtn'), saveBtn: $('#saveBtn'), container: $('#spread-container'), list: $('#history'), main: $('main') };
  let currentDeck = [];
  
  // Initialize Particle System
  const particles = new ParticleSystem('particle-canvas');

  function init(){
    for(const key in spreads){
      const opt = document.createElement('option');
      opt.value = key; opt.textContent = spreads[key].name;
      el.select.appendChild(opt);
    }
    el.select.value = 'oneCard';
    deploySpread();
  }

  function prepareDeck(){
    currentDeck = [...baseDeck];
    for (let i = currentDeck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
    }
  }

  function drawCard(){
    if(currentDeck.length === 0) prepareDeck();
    const card = currentDeck.pop();
    const isRev = Math.random() < 0.5;
    return { ...card, isReversed: isRev };
  }

  function deploySpread(){
    const spreadKey = el.select.value;
    const spreadData = spreads[spreadKey];
    prepareDeck();
    el.container.innerHTML = '';
    addLog('System', `Spread: ${spreadData.name}`);

    spreadData.positions.forEach(pos => {
      createCardSlot(pos, spreadKey === 'celticCross');
    });
  }

  function createCardSlot(posInfo, isCeltic){
    const slot = document.createElement('div');
    slot.className = 'card-slot';
    slot.style.top = `${posInfo.pos[0]}%`;
    slot.style.left = `${posInfo.pos[1]}%`;
    if(posInfo.rotate) slot.style.transform = `rotate(${posInfo.rotate}deg)`;
    if(posInfo.z) slot.style.zIndex = posInfo.z;

    slot.innerHTML = `
      <div class="card">
        <div class="card-face card-back">
          <span>${posInfo.id}</span>
          <span style="font-size:10px; margin-top:4px; text-align:center;">${posInfo.mean}</span>
        </div>
        <div class="card-face card-front"></div>
      </div>
    `;

    // Click Interaction with Particles
    slot.onclick = function(e){
      if(this.classList.contains('flipped')) return;
      
      // Trigger Particle Explosion at click coordinates
      // adjust for canvas offset if needed (here canvas is full screen relative to main)
      const rect = el.main.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      particles.createExplosion(x, y);

      const c = drawCard();
      const frontFace = this.querySelector('.card-front');
      const mean = c.isReversed ? c.advice_rev : c.advice;
      const revTag = c.isReversed ? '<span class="reversed-tag">‚ñºREVERSED</span>' : '';
      
      if(c.isReversed) frontFace.classList.add('reversed-state');

      frontFace.innerHTML = `
        <div class="pos-badge">${posInfo.id}. ${posInfo.mean}</div>
        <div class="card-content-wrap">
          ${revTag}
          <span class="suit-icon suit-${c.suit}">${c.icon}</span>
          <span class="card-name">${c.name}</span>
          <div class="card-meaning">${mean}</div>
        </div>
      `;
      
      this.classList.add('flipped');
      addLog('Reveal', `${posInfo.mean}: ${c.name}`, c.isReversed);
    };

    el.container.appendChild(slot);
  }

  function addLog(header, detail, isRev=false){
    const li = document.createElement('li');
    if(isRev) li.className = 'rev';
    li.innerHTML = `<span class="log-header">${header}</span><span class="log-detail">${detail}</span>`;
    el.list.prepend(li);
  }

  el.saveBtn.onclick = function(){
    const target = el.main;
    const originalText = el.saveBtn.textContent;
    el.saveBtn.textContent = "Saving...";
    html2canvas(target, { backgroundColor: '#0b0f14', scale: 2, useCORS: true, logging: false }).then(canvas => {
      const link = document.createElement('a');
      link.download = `tarot_result_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      el.saveBtn.textContent = originalText;
    }).catch(err => {
      console.error(err);
      alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
      el.saveBtn.textContent = originalText;
    });
  };

  el.btn.onclick = deploySpread;
  init();
})();
</script>
</body>
</html>